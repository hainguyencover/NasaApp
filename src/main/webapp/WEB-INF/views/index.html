<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NASA - ·∫¢nh c·ªßa Ng√†y v·ªõi Ph√¢n trang</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .content {
      padding: 40px;
    }

    .alert {
      padding: 15px 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      font-weight: 500;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .image-section {
      text-align: center;
      margin-bottom: 40px;
    }

    #img-of-the-day {
      max-width: 100%;
      height: auto;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    #loading {
      font-size: 1.2em;
      color: #667eea;
      padding: 40px;
    }

    .comment-form {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 40px;
    }

    .comment-form h2 {
      color: #1e3c72;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .form-group input[type="text"],
    .form-group input[type="file"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .error-message {
      color: #dc3545;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .rating-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .rating-btn {
      padding: 10px 20px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.3s;
    }

    .rating-btn:hover {
      border-color: #667eea;
      background: #f0f0ff;
    }

    .rating-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .file-upload-info {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    /* Filter and Sort Controls */
    .filter-controls {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-group label {
      font-weight: 600;
      color: #333;
    }

    .filter-group select,
    .filter-group input[type="date"] {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      background: white;
    }

    .filter-btn {
      padding: 8px 20px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .comments-section h2 {
      color: #1e3c72;
      margin-bottom: 30px;
    }

    .comment-card {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
      border-left: 5px solid #667eea;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .comment-author {
      font-weight: 600;
      font-size: 1.1em;
      color: #1e3c72;
    }

    .comment-rating {
      color: #ffc107;
      font-size: 1.2em;
    }

    .comment-text {
      color: #555;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .comment-image {
      max-width: 300px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .comment-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .comment-time {
      color: #999;
      font-size: 0.9em;
    }

    .comment-actions {
      display: flex;
      gap: 10px;
    }

    .like-btn, .delete-btn {
      background: white;
      border: 2px solid #e0e0e0;
      padding: 8px 20px;
      border-radius: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      font-size: 0.95em;
    }

    .like-btn:hover {
      border-color: #667eea;
      background: #f0f0ff;
    }

    .delete-btn:hover {
      border-color: #dc3545;
      background: #fff5f5;
      color: #dc3545;
    }

    .no-comments {
      text-align: center;
      color: #999;
      padding: 40px;
      font-size: 1.1em;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üåå NASA Astronomy Picture of the Day</h1>
    <p>Kh√°m ph√° v≈© tr·ª• m·ªói ng√†y v·ªõi m·ªôt b·ª©c ·∫£nh m·ªõi - Version 2.0 v·ªõi Ph√¢n trang</p>
  </div>

  <div class="content">
    <!-- Alert Messages -->
    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>
    <div th:if="${likeMessage}" class="alert alert-info" th:text="${likeMessage}"></div>

    <!-- NASA Image -->
    <div class="image-section">
      <div id="loading">ƒêang t·∫£i ·∫£nh c·ªßa ng√†y...</div>
      <img id="img-of-the-day" style="display:none;" alt="NASA Picture of the Day"/>
    </div>

    <!-- Comment Form with Data Binding -->
    <div class="comment-form">
      <h2>ƒê√°nh gi√° v√† B√¨nh lu·∫≠n</h2>
      <form th:action="@{/comment/add}" th:object="${comment}" method="post" enctype="multipart/form-data">

        <!-- Hidden fields to preserve pagination state -->
        <input type="hidden" name="page" th:value="${currentPage}"/>
        <input type="hidden" name="size" th:value="${pageSize}"/>
        <input type="hidden" name="sortBy" th:value="${sortBy}"/>
        <input type="hidden" name="direction" th:value="${direction}"/>
        <input type="hidden" name="filter" th:value="${filter}"/>

        <div class="form-group">
          <label for="authorName">T√™n c·ªßa b·∫°n:</label>
          <input type="text" id="authorName" th:field="*{authorName}" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n"/>
          <div class="error-message" th:if="${#fields.hasErrors('authorName')}" th:errors="*{authorName}"></div>
        </div>

        <div class="form-group">
          <label>ƒê√°nh gi√° (1-5 sao):</label>
          <div class="rating-group">
            <button type="button" class="rating-btn" data-rating="1">‚≠ê 1</button>
            <button type="button" class="rating-btn" data-rating="2">‚≠ê 2</button>
            <button type="button" class="rating-btn" data-rating="3">‚≠ê 3</button>
            <button type="button" class="rating-btn" data-rating="4">‚≠ê 4</button>
            <button type="button" class="rating-btn" data-rating="5">‚≠ê 5</button>
          </div>
          <input type="hidden" id="rating" th:field="*{rating}"/>
          <div class="error-message" th:if="${#fields.hasErrors('rating')}" th:errors="*{rating}"></div>
        </div>

        <div class="form-group">
          <label for="commentText">Nh·∫≠n x√©t:</label>
          <textarea id="commentText" th:field="*{commentText}" placeholder="Chia s·∫ª suy nghƒ© c·ªßa b·∫°n v·ªÅ b·ª©c ·∫£nh n√†y..."></textarea>
          <div class="error-message" th:if="${#fields.hasErrors('commentText')}" th:errors="*{commentText}"></div>
        </div>

        <!-- MultipartFile Upload -->
        <div class="form-group">
          <label for="imageFile">ƒê√≠nh k√®m ·∫£nh (t√πy ch·ªçn):</label>
          <input type="file" id="imageFile" name="imageFile" accept="image/*"/>
          <div class="file-upload-info">Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh, t·ªëi ƒëa 5MB</div>
        </div>

        <button type="submit" class="submit-btn">G·ª≠i ƒë√°nh gi√°</button>
      </form>
    </div>

    <!-- Filter and Sort Controls -->
    <div class="filter-controls">
      <div class="filter-group">
        <label for="filterSelect">Hi·ªÉn th·ªã:</label>
        <select id="filterSelect" onchange="applyFilter()">
          <option th:selected="${filter == 'today'}" value="today">H√¥m nay</option>
          <option th:selected="${filter == 'all'}" value="all">T·∫•t c·∫£</option>
          <option th:selected="${filter == 'date'}" value="date">Theo ng√†y</option>
        </select>
      </div>

      <div class="filter-group" id="dateFilterGroup" th:style="${filter == 'date' ? 'display: flex;' : 'display: none;'}">
        <label for="dateFilter">Ng√†y:</label>
        <input type="date" id="dateFilter" th:value="${selectedDate}"/>
      </div>

      <div class="filter-group">
        <label for="sortSelect">S·∫Øp x·∫øp:</label>
        <select id="sortSelect" onchange="applyFilter()">
          <option th:selected="${sortBy == 'createdAt' and direction == 'DESC'}" value="createdAt-DESC">M·ªõi nh·∫•t</option>
          <option th:selected="${sortBy == 'createdAt' and direction == 'ASC'}" value="createdAt-ASC">C≈© nh·∫•t</option>
          <option th:selected="${sortBy == 'likes'}" value="likes-DESC">Nhi·ªÅu like nh·∫•t</option>
          <option th:selected="${sortBy == 'rating' and direction == 'DESC'}" value="rating-DESC">ƒê√°nh gi√° cao nh·∫•t</option>
          <option th:selected="${sortBy == 'rating' and direction == 'ASC'}" value="rating-ASC">ƒê√°nh gi√° th·∫•p nh·∫•t</option>
        </select>
      </div>

      <button type="button" class="filter-btn" onclick="applyFilter()">√Åp d·ª•ng</button>
      <button type="button" class="filter-btn" onclick="resetFilter()">ƒê·∫∑t l·∫°i</button>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
      <h2>
        Danh s√°ch ƒë√°nh gi√°
        <span th:if="${filter == 'today'}">(H√¥m nay)</span>
        <span th:if="${filter == 'date' and selectedDate != null}" th:text="'(' + ${#temporals.format(selectedDate, 'dd/MM/yyyy')} + ')'"></span>
      </h2>

      <div th:if="${commentPage.totalElements == 0}" class="no-comments">
        Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n! üöÄ
      </div>

      <div th:if="${commentPage.hasContent()}">
        <!-- Comment Cards -->
        <div th:each="c : ${commentPage.content}" class="comment-card">
          <div class="comment-header">
            <span class="comment-author" th:text="${c.authorName}">Author</span>
            <span class="comment-rating">
                                <th:block th:each="i : ${#numbers.sequence(1, c.rating)}">‚≠ê</th:block>
                            </span>
          </div>
          <div class="comment-text" th:text="${c.commentText}">Comment text</div>

          <!-- Display uploaded image if exists -->
          <img th:if="${c.imagePath != null and c.imagePath != ''}"
               th:src="@{'/uploads/' + ${c.imagePath}}"
               class="comment-image"
               alt="User uploaded image"/>

          <div class="comment-footer">
                            <span class="comment-time">
                                <th:block th:text="${c.createdAt.hour}">00</th:block>:<th:block th:text="${c.createdAt.minute < 10 ? '0' + c.createdAt.minute : c.createdAt.minute}">00</th:block>
                                - <th:block th:text="${#temporals.format(c.commentDate, 'dd/MM/yyyy')}">date</th:block>
                            </span>
            <div class="comment-actions">
              <!-- Like Button -->
              <form th:action="@{/comment/like}" method="post" style="display:inline;">
                <input type="hidden" name="commentId" th:value="${c.id}"/>
                <input type="hidden" name="page" th:value="${currentPage}"/>
                <input type="hidden" name="size" th:value="${pageSize}"/>
                <input type="hidden" name="sortBy" th:value="${sortBy}"/>
                <input type="hidden" name="direction" th:value="${direction}"/>
                <input type="hidden" name="filter" th:value="${filter}"/>
                <button type="submit" class="like-btn">
                  ‚ù§Ô∏è <span th:text="${c.likeCount}">0</span>
                </button>
              </form>

              <!-- Delete Button -->
              <form th:action="@{'/comment/delete/' + ${c.id}}" method="post" style="display:inline;">
                <input type="hidden" name="page" th:value="${currentPage}"/>
                <input type="hidden" name="size" th:value="${pageSize}"/>
                <input type="hidden" name="sortBy" th:value="${sortBy}"/>
                <input type="hidden" name="direction" th:value="${direction}"/>
                <input type="hidden" name="filter" th:value="${filter}"/>
                <button type="submit" class="delete-btn" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?')">
                  üóëÔ∏è X√≥a
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Pagination Component -->
        <div th:replace="~{pagination :: pagination(${commentPage}, '/')}"></div>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  // Load NASA APOD
  var nasaApiKey = /*[[${nasaApiKey}]]*/ '';
  var nasaApiUrl = /*[[${nasaApiUrl}]]*/ '';
  var query = nasaApiUrl + '?api_key=' + nasaApiKey;

  var request = new XMLHttpRequest();
  request.open('GET', query);
  request.onload = function() {
    if (request.status === 200) {
      var response = JSON.parse(request.responseText);
      var img = document.getElementById('img-of-the-day');
      img.setAttribute('src', response.url);
      img.style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }
  };
  request.send();

  // Rating buttons
  var ratingBtns = document.querySelectorAll('.rating-btn');
  var ratingInput = document.getElementById('rating');

  ratingBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      ratingBtns.forEach(function(b) {
        b.classList.remove('active');
      });
      this.classList.add('active');
      ratingInput.value = this.getAttribute('data-rating');
    });
  });

  // Set active rating if exists
  var currentRating = ratingInput.value;
  if (currentRating) {
    ratingBtns.forEach(function(btn) {
      if (btn.getAttribute('data-rating') === currentRating) {
        btn.classList.add('active');
      }
    });
  }

  // Filter functions
  function applyFilter() {
    var filterValue = document.getElementById('filterSelect').value;
    var sortValue = document.getElementById('sortSelect').value;
    var sortParts = sortValue.split('-');
    var sortBy = sortParts[0];
    var direction = sortParts[1];

    var url = new URL(window.location.href);
    url.searchParams.set('page', '0'); // Reset to first page
    url.searchParams.set('filter', filterValue);
    url.searchParams.set('sortBy', sortBy);
    url.searchParams.set('direction', direction);

    // Add date parameter if filter is 'date'
    if (filterValue === 'date') {
      var dateValue = document.getElementById('dateFilter').value;
      if (dateValue) {
        url.searchParams.set('date', dateValue);
      }
    } else {
      url.searchParams.delete('date');
    }

    window.location.href = url.toString();
  }

  function resetFilter() {
    window.location.href = '/';
  }

  // Show/hide date filter based on filter selection
  document.getElementById('filterSelect').addEventListener('change', function() {
    var dateGroup = document.getElementById('dateFilterGroup');
    if (this.value === 'date') {
      dateGroup.style.display = 'flex';
    } else {
      dateGroup.style.display = 'none';
    }
  });
  /*]]>*/
</script>
</body>
</html>
